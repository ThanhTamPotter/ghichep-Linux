# Cáº¥u hÃ¬nh service discovery trÃªn prometheus 

### ***Má»¥c lá»¥c***

[1. Giá»›i thiá»‡u](#1)

[2. File-based service discovery : file_sd_configs](#2)

[3. DNS-based service discovery: dns_sd_config ](#3)

[4. Openstack service discovery: openstack_sd_config](#4)

[Tham kháº£o](#thamkhao)

---

<a name = '1'></a>

## 1. Giá»›i thiá»‡u

NhÆ° hÆ°á»›ng dáº«n á»Ÿ pháº§n setup exporter trÆ°á»›c, mÃ¬nh Ä‘ang xá»­ lÃ½ viá»‡c cáº­p nháº­t cÃ¡c target cáº§n monitor thÃ´ng qua cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t lÃ  cáº¥u hÃ¬nh tÄ©nh thÃ´ng qua `static_config`. CÃ¡c xá»­ lÃ½ nÃ y khÃ¡ á»•n trong cÃ¡c trÆ°á»ng há»£p mÃ´ hÃ¬nh monitor Ä‘Æ¡n giáº£n, Ã­t target cáº§n monitor, nhÆ°ng Ä‘i kÃ¨m má»™t nhÆ°á»£c Ä‘iá»ƒm lÃ  cáº§n pháº£i update thá»§ cÃ´ng  thÃ´ng tin cÃ¡c target thÃªm vÃ o hoáº·c xÃ³a Ä‘i thÃ´ng qua file `prometheus.yml` + reload láº¡i prometheus Ä‘á»ƒ nháº­n thÃ´ng tin cáº¥u hÃ¬nh má»›i. NhÆ°á»£c Ä‘iá»ƒm nÃ y cÃ ng trá»Ÿ nÃªn tráº§m trá»ng vÃ  gÃ¢y "ngu xi" khi quáº£n trá»‹ prometheus trong mÃ´i trÆ°á»ng vá»›i cÃ¡c target update liÃªn tá»¥c Ä‘Æ°á»£c thÃªm vÃ o hoáº·c xÃ³a Ä‘i theo tá»«ng phÃºt. 

**â˜** Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y thÃ¬ Prometheus Ä‘Ã£ há»— trá»£ tÃ­nh nÄƒng **service discovery** cho phÃ©p chÃºng ta cÃ³ thá»ƒ cáº¥u hÃ¬nh Ä‘á»ƒ prometheus update liÃªn tá»¥c cÃ¡c target cáº§n monitor mÃ  khÃ´ng cáº§n cÃ¡c tÃ¡c Ä‘á»™ng thá»§ cÃ´ng lÃªn há»‡ thá»‘ng vÃ  file cáº¥u hÃ¬nh `prometheus.yml`. Theo nhÆ° tÃ i liá»‡u chÃ­nh thá»©c cá»§a Prometheus thÃ¬ hiá»‡n táº¡i Ä‘ang há»— trá»£ cÃ¡c cÆ¡ cháº¿ discovery sau: 

- azure_sd_configs: Azure Service Discovery
- consul_sd_configs: Consul Service Discovery
- dns_sd_configs: DNS Service Discovery
- ec2_sd_configs: EC2 Service Discovery
- openstack_sd_configs: OpenStack Service Discovery
- file_sd_configs: File Service Discovery
- gce_sd_configs: GCE Service Discovery
- kubernetes_sd_configs: Kubernetes Service Discovery
- marathon_sd_configs: Marathon Service Discovery
- nerve_sd_configs: AirBnBâ€™s Nerve Service Discovery
- serverset_sd_configs: Zookeeper Serverset Service Discovery
- triton_sd_configs: Triton Service Discovery

PhÃ¹ há»£p vá»›i nhu cáº§u thá»±c táº¿ cáº§n sá»­ dá»¥ng thÃ¬ pháº§n ghi chÃ©p nÃ y sáº½ lÆ°u láº¡i cÃ¡c thÃ´ng tin khi cáº¥u hÃ¬nh service discovery sá»­ dá»¥ng: **file_sd_configs**, **dns_sd_configs**, **openstack_sd_configs**.

<a name = '2'></a>

## 2. File-based service discovery : file_sd_configs

Prometheus chÃ³ phÃ©p nhiá»u tÃ¹y chá»n  cho cÆ¡ cháº¿ service discovery Ä‘á»ƒ khÃ¡m phÃ¡ ra cÃ¡c target cáº§n scrape metrics, bao gá»“m: Kubernetes, Consul, Zookeeper, ... Tuy nhiÃªn, náº¿u báº¡n cáº§n cáº¥u hÃ¬nh cho cÃ¡c target mÃ  chÆ°a cÃ³ option há»— trá»£ táº­n rÄƒng nhÆ° cÃ¡c há»‡ thá»‘ng trÃªn thÃ¬ Ä‘Æ¡n giáº£n sáº½ sá»­ dá»¥ng cÆ¡ cháº¿ discovery thÃ´ng qua file-based vÃ  dns based. 

CÆ¡ cháº¿  [file-based service discovery](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config)  cho phÃ©p update cÃ¡c target cáº§n monitor trong file Ä‘á»‹nh dáº¡ng json hoáº·c yaml. Khi cÃ¡c file nÃ y thay Ä‘á»•i, danh sÃ¡ch cÃ¡c target Ä‘Æ°á»£c Ä‘á»c tá»« file vÃ  prometheus sáº½ scrape chÃ­nh xÃ¡c cÃ¡c target má»›i Ä‘Æ°á»£c update vÃ  khÃ´ng cáº§n pháº£i restart/reload láº¡i prometheus. 

File list cÃ¡c target cÃ³  thá»ƒ viáº¿t dÆ°á»›i dáº¡ng yaml (vd: `targets.yml`) : 

```yaml
- targets: ['192.168.10.20:9149', '192.168.10.21:9149']
  labels:
    job: 'Monitor_RabbitMQ'

- targets: ['192.168.10.20:9180', '192.168.10.20:9180']
  labels:
    job: 'Monitor_Openstack'
```

Hoáº·c Ä‘á»‹nh dáº¡ng json  (vd:  `targets.json`):

```json
[
  {
    "targets": ["192.168.10.20:9180", "192.168.10.20:9180"],
    "labels": {
      "job": "Monitor_Openstack"
    }
  },
  {
    "targets": ["192.168.10.1:9149", "192.168.10.21:9149"],
    "labels": {
      "job": "Monitor_RabbitMQ"
    }
  }
]
```

Trong file config cá»§a prometheus (`prometheus.yml`), cáº¥u hÃ¬nh file-based service discovery nhÆ° sau: 

```yml
scrape_configs:
...
- job_name: 'Monitor_RabbitMQ'
  file_sd_configs:
  - files: ['targets.json'] # or ['targets.yml']
  
- job_name: 'Monitor_Openstack'
  file_sd_configs:
  - files: ['targets.json'] # or ['targets.yml']
```

NhÆ° váº­y, prometheus sáº½ load cáº¥u hÃ¬nh cÃ¡c target tá»« file `targets.json` / `targets.yml` trong thÆ° má»¥c cáº¥u hÃ¬nh cá»§a prometheus (`/etc/prometheus/`). Show trÃªn giao diá»‡n cá»§a Prometheus ta tháº¥y nhÆ° sau: 

![img](./images/11.1.png)

CÃ¡c target Ä‘Ã£ Ä‘Æ°á»£c update Ä‘á»ƒ prometheus cÃ³ thá»ƒ discover ra vÃ  pull metrics vá». á» Ä‘Ã¢y cÃ³ má»™t lÆ°u Ã½ nhá» lÃ  táº¡i prometheus mÃ¬nh cÃ³ cáº¥u hÃ¬nh thÃ nh 2 job cÃ¹ng trá» vÃ o file `targets.json` nÃªn lÃºc show ra á»Ÿ Ä‘Ã¢y thÃ¬ sáº½ bá»‹ duplicate cÃ¡c service discovery. 

Thá»±c hiá»‡n update thay add thÃªm targets vÃ o file Ä‘á»ƒ tháº¥y sá»± thay Ä‘á»•i trÃªn prometheus:

![img](./images/11.2.png)

Ngay láº­p tá»©c, prometheus phÃ¡t hiá»‡n ra cÃ³ sá»± thay Ä‘á»•i vÃ  reload láº¡i config cá»§a nÃ³. Check trÃªn giao diá»‡n web tháº¥y Ä‘Ã£ cÃ³ target má»›i thÃªm vÃ o : 

![img](./images/11.3.png)

**â˜**: Vá»›i cÆ¡ cháº¿ file-based discovery thÃ¬ khi mÃ¬nh add hoáº·c remove má»™t target, ngay láº­p tá»©c prometheus update láº¡i cáº¥u hÃ¬nh vÃ  thÃ´ng tin cÃ¡c target. ***Náº¿u file targets.json cáº¥u hÃ¬nh bá»‹ lá»—i sai cÃº phÃ¡p thÃ¬ lÃºc Ä‘Ã³, prometheus sáº½ khÃ´ng pull dá»¯ liá»‡u tá»« cÃ¡c target trong file Ä‘Ã³ vá» ná»¯a.***

<a name = '3'></a>

## 3. DNS-based service discovery: dns_sd_config 

CÆ¡ cháº¿ DNS-based service discovery cho phÃ©p xÃ¡c Ä‘á»‹nh táº­p cÃ¡c DNS domains name mÃ  Ä‘á»‹nh kÃ¬ Ä‘Æ°á»£c truy váº¥n láº¡i Ä‘á»ƒ tÃ¬m ra danh sÃ¡ch cÃ¡c target. DNS server pháº£i Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ truy váº¥n tá»›i trong file `/etc/resolv.conf`

PhÆ°Æ¡ng thá»©c nÃ y chá»‰ há»— trá»£ cÃ¡c báº£n ghi DNS cÆ¡ báº£n: A, AAAA vÃ  SRV.

CÃ¡ch thá»©c lÃ m viá»‡c cá»§a cÆ¡ cháº¿ nÃ y Ä‘Ã³ lÃ : prometheus sáº½ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ láº¥y cÃ¡i target mÃ  Ä‘ang Ä‘Æ°á»£c trá» tá»›i má»™t domain name. Theo chu kÃ¬, prometheus sáº½ query láº¡i tá»›i DNS server Ä‘á»ƒ biáº¿t Ä‘Æ°á»£c cÃ¡c IP Ä‘ang trá» tá»›i domain Ä‘Ã³, vÃ  nÃ³ sáº½ nháº­n cÃ¡c IP nÃ y lÃ  target cáº§n pull metric vá». 

Khi Prometheus truy váº¥n tá»›i cÃ¡c báº£n ghi DNS (A, AAAA, SRV), má»—i target sáº½ Ä‘Æ°á»£c gÃ¡n vá»›i label tÃªn lÃ  `__meta_dns_name`. GiÃ¡ trá»‹ Ä‘Ã³ Ä‘Æ°á»£c Ä‘áº·t cho báº£n ghi cáº¥u hÃ¬nh trong Prometheus. 

Äá»ƒ hiá»ƒu rÃµ hÆ¡n cÆ¡ cháº¿ lÃ m viá»‡c thÃ¬ ta sáº½ thá»±c hiá»‡n lab nhÆ° sau: 

- Dá»±ng má»™t DNS server trÃªn local. (CÃ³ thá»ƒ tham kháº£o hÆ°á»›ng dáº«n sau:  https://www.alibabacloud.com/blog/how-to-setup-dns-server-using-bind9-on-ubuntu-16-04_594469 )

- Cáº¥u hÃ¬nh DNS server vá»›i báº£n ghi A cho domain báº¥t kÃ¬: 

  VÃ­ dá»¥: 

  ```bash
  ;
  ; BIND reverse data file for local loopback interface
  ;
  $TTL    604800
  @       IN      SOA     test.idc.tamntt. root.idc.tamntt.  (
                                1         ; Serial
                           604800         ; Refresh
                            86400         ; Retry
                          2419200         ; Expire
                           604800 )       ; Negative Cache TTL
  ;
  @       IN      NS      test.idc.tamntt.
  test    IN      A       10.10.71.53
  prom-ctl1       IN      A       10.10.71.54
  ```

  Cáº¥u hÃ¬nh server prometheus add thÃªm nameserver lÃ  DNS server local vá»«a dá»±ng (chá»‰nh trong file `/etc/resolv.conf`). Kiá»ƒm tra thÃ´ng tin domain Ä‘Ã£ Ä‘Æ°á»£c trá» thÃ nh cÃ´ng nhÆ° sau: 

  ```bash
  # dig prom-ctl1.idc.tamntt
  
  ; <<>> DiG 9.10.3-P4-Ubuntu <<>> prom-ctl1.idc.tamntt
  ;; global options: +cmd
  ;; Got answer:
  ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3035
  ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2
  
  ;; OPT PSEUDOSECTION:
  ; EDNS: version: 0, flags:; udp: 4096
  ;; QUESTION SECTION:
  ;prom-ctl1.idc.tamntt.          IN      A
  
  ;; ANSWER SECTION:
  prom-ctl1.idc.tamntt.   604800  IN      A       10.10.71.54
  
  ;; AUTHORITY SECTION:
  idc.tamntt.             604800  IN      NS      test.idc.tamntt.
  
  ;; ADDITIONAL SECTION:
  test.idc.tamntt.        604800  IN      A       10.10.71.53
  
  ;; Query time: 0 msec
  ;; SERVER: 10.10.71.53#53(10.10.71.53)
  ;; WHEN: Mon Nov 18 22:59:18 ICT 2019
  ;; MSG SIZE  rcvd: 100
  
  ```

  NhÆ° váº­y, á»Ÿ trÃªn Ä‘Ã£ cáº¥u hÃ¬nh báº£n ghi A domain: prom-ctl1.idc.tamntt trá» vá» IP: 10.10.71.54.

- Thá»±c hiá»‡n cáº¥u hÃ¬nh `dns_sd_config` trong file cáº¥u hÃ¬nh cá»§a prometheus: 

  ```yaml
  scrape_configs:
  # ...
    - job_name: 'dns_discovery'
      scrape_interval: 20s
      scrape_timeout: 20s
      dns_sd_configs:
      - names:
        - 'prom-ctl1.idc.tamntt'
        type: A
        port: 9121
  ```

  Reload láº¡i prometheus, check trÃªn giao diá»‡n tháº¥y cÃ³ serivce discovery cá»§a DNS nhÆ° sau: 

  ![img](./images/11.4.png)

- Tiáº¿n hÃ nh add thÃªm IP vÃ o domain **prom-ctl1.idc.tamntt** vÃ o DNS server. Check láº¡i truy váº¥n tá»›i domain ta cÃ³ 2 IP nhÆ° sau: 

  ![img](./images/11.5.png)

- Check láº¡i trÃªn prometheus, ta tháº¥y nÃ³ Ä‘Ã£ discover ra thÃªm target má»›i - chÃ­nh lÃ  IP má»›i vá»«a Ä‘Æ°á»£c trá» domain trong DNS: 

  ![img](./images/11.6.png)



<a name = '4'></a>

## 4. Openstack service discovery: openstack_sd_config 

Trong lÃºc lang thang nghá»‹ch ngá»£m vá» service discovery thÃ´ng qua file-based vÃ  dns-based, mÃ¬nh Ä‘Ã£ vÃ´ tÃ¬nh va pháº£i cÃ¡i nÃ y. Tháº¥y cÃ³ váº» hay hay nÃªn test thá»­ luÃ´n. MÃ  tháº­t Ã©o le lÃ  cáº£m giÃ¡c Ä‘á»c cÃ¡i nÃ y rá»“i mÃ¬nh má»›i ngá»™ ra Ä‘Æ°á»£c cÃ´ng dá»¥ng cá»§a service discovery lÃ  gÃ¬ váº­y. haha.  ğŸ˜Œ 

Openstack SD cho phÃ©p truy xuáº¥t Ä‘Æ°á»£c cÃ¡c target tá»« cÃ¡c Nova instance. CÃ³ 2 kiá»ƒu cáº¥u hÃ¬nh discover target: 

- **hypervisor**: role nÃ y cho phÃ©p discover má»™t target cho má»—i má»™t Nova node. Äá»‹a chá»‰ cá»§a target sáº½ Ä‘áº·t máº·c Ä‘á»‹nh lÃ  thÃ´ng sá»‘ `host_ip` cá»§a node. 

  Má»™t sá»‘ meta label cho role nÃ y: 

  - `__meta_openstack_hypervisor_host_ip`: the hypervisor node's IP address.
  - `__meta_openstack_hypervisor_name`: the hypervisor node's name.
  - `__meta_openstack_hypervisor_state`: the hypervisor node's state.
  - `__meta_openstack_hypervisor_status`: the hypervisor node's status.
  - `__meta_openstack_hypervisor_type`: the hypervisor node's type.

- **instance**: role instance cho phÃ©p discover má»™t target theo má»—i network interface cá»§a instance. Äá»‹a chá»‰ cá»§a target Ä‘áº·t máº·c Ä‘á»‹nh lÃ  Ä‘á»‹a chá»‰ IP private cá»§a network interface. 

  Má»™t sá»‘ meta label cho metric role nÃ y: 

  - `__meta_openstack_address_pool`: the pool of the private IP.
  - `__meta_openstack_instance_flavor`: the flavor of the OpenStack instance.
  - `__meta_openstack_instance_id`: the OpenStack instance ID.
  - `__meta_openstack_instance_name`: the OpenStack instance name.
  - `__meta_openstack_instance_status`: the status of the OpenStack instance.
  - `__meta_openstack_private_ip`: the private IP of the OpenStack instance.
  - `__meta_openstack_project_id`: the project (tenant) owning this instance.
  - `__meta_openstack_public_ip`: the public IP of the OpenStack instance.
  - `__meta_openstack_tag_`: each tag value of the instance.
  - `__meta_openstack_user_id`: the user account owning the tenant.

Ká»‹ch báº£n sá»­ dá»¥ng Openstack SD lÃ  prometheus sáº½ discover ra vÃ  thá»±c hiá»‡n monitor khi cÃ³ má»™t instance má»›i trong há»‡ thá»‘ng Ä‘Æ°á»£c táº¡o ra. NÃ³ sáº½ ngay láº­p tá»©c discover ra Ä‘á»‹a chá»‰ IP cá»§a instance Ä‘Ã³ vÃ  thá»±c hiá»‡n pull metric tá»« port cá»§a node_exporter Ä‘Ã£ Ä‘Æ°á»£c cÃ i sáºµn trong cÃ¡c image nÃ y cá»§a instance cháº³ng háº¡n. 

VÃ­ dá»¥: Cáº¥u hÃ¬nh prometheus discover instance cá»§a Openstack: 

```yaml
  - job_name: 'openstack_sd'
    scrape_interval: 60s
    scrape_timeout: 60s
    openstack_sd_configs:
    - role: instance
      region: 'RegionOneTwoThree'
      identity_endpoint: 'https://<keystone_endpoint>:35357/v3'
      username: admin
      password: <admin_password>
      domain_name: 'Default'
      project_name: 'admin'
      port: 9100
```

Reload láº¡i cáº¥u hÃ¬nh cá»§a Prometheus. Má»—i khi instance má»›i Ä‘Æ°á»£c táº¡i, promtheus sáº½ discover ra IP_X cá»§a nÃ³ vÃ  add thÃªm target IP_X:9100 Ä‘á»ƒ thá»±c hiá»‡n pull metrics tá»« Ä‘Ã³ vá». 

<a name = 'thamkhao'></a>

### Tham kháº£o

[1] https://prometheus.io/blog/2015/06/01/advanced-service-discovery

[2]  https://prometheus.io/docs/guides/file-sd/ 

[2]  https://prometheus.io/docs/prometheus/latest/configuration/configuration/ 

[3]  https://medium.com/@pasquier.simon/monitoring-your-openstack-instances-with-prometheus-a7ff4324db6c 